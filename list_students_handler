#!/usr/bin/env python3
"""
ASPIRATION BOT - Aspire Youth Academy Grade 8
Complete Assignment & Attendance System
Author: System Administrator
Version: 3.2 - Improved /liststudents with names
"""

import telebot
import json
import os
import sqlite3
from datetime import datetime, timedelta
import logging
from typing import Dict, List, Tuple

# ===================== CONFIGURATION =====================
BOT_TOKEN = "8247448831:AAHkXdidOfZGwj42SoqjNwkQiw5l4CKQmnk"
SCHOOL_NAME = "Aspire Youth Academy"
GRADE = "Grade 8"

# Files for storing data
ADMINS_FILE = "admins.json"
TEACHERS_FILE = "teachers.json"
ATTENDANCE_FILE = "attendance.json"
ASSIGNMENTS_FILE = "assignments.json"
SUBMISSIONS_FILE = "submissions.json"
DB_FILE = "school_bot.db"

# ===================== ASSIGNMENT MANAGER =====================
class AssignmentManager:
    """Manage assignments and submissions"""
    
    def __init__(self):
        self.assignments = self.load_data(ASSIGNMENTS_FILE)
        self.submissions = self.load_data(SUBMISSIONS_FILE)
    
    def load_data(self, filename):
        """Load data from JSON file"""
        try:
            with open(filename, 'r') as f:
                return json.load(f)
        except FileNotFoundError:
            return {}
    
    def save_data(self, data, filename):
        """Save data to JSON file"""
        with open(filename, 'w') as f:
            json.dump(data, f, indent=2)
    
    def save_assignments(self):
        self.save_data(self.assignments, ASSIGNMENTS_FILE)
    
    def save_submissions(self):
        self.save_data(self.submissions, SUBMISSIONS_FILE)
    
    def create_assignment(self, teacher_id, teacher_username, subject, title, description, due_date):
        """Create new assignment"""
        assignment_id = str(int(datetime.now().timestamp()))
        
        assignment = {
            "id": assignment_id,
            "teacher_id": teacher_id,
            "teacher_username": teacher_username,
            "subject": subject,
            "title": title,
            "description": description,
            "due_date": due_date,
            "created_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "status": "active",
            "total_students": 0,
            "submitted": 0,
            "graded": 0
        }
        
        self.assignments[assignment_id] = assignment
        self.save_assignments()
        
        return assignment_id, assignment
    
    def get_active_assignments(self):
        """Get all active assignments"""
        active = {}
        for assignment_id, assignment in self.assignments.items():
            if assignment.get("status") == "active":
                active[assignment_id] = assignment
        return active
    
    def get_assignment_by_id(self, assignment_id):
        """Get assignment by ID"""
        return self.assignments.get(assignment_id)
    
    def get_student_assignments(self, student_id):
        """Get assignments for a student"""
        student_assignments = []
        student_id_str = str(student_id)
        
        for assignment_id, assignment in self.assignments.items():
            if assignment.get("status") == "active":
                # Check if student has already submitted
                submission_key = f"{assignment_id}_{student_id_str}"
                submitted = submission_key in self.submissions
                
                student_assignment = assignment.copy()
                student_assignment["assignment_id"] = assignment_id
                student_assignment["submitted"] = submitted
                
                if submitted:
                    submission = self.submissions[submission_key]
                    student_assignment["submission_time"] = submission.get("submitted_at")
                    student_assignment["grade"] = submission.get("grade")
                    student_assignment["feedback"] = submission.get("feedback")
                    student_assignment["graded"] = submission.get("graded", False)
                
                student_assignments.append(student_assignment)
        
        return student_assignments
    
    def receive_assignment(self, student_id, student_username, assignment_id):
        """Student receives an assignment"""
        student_id_str = str(student_id)
        assignment = self.get_assignment_by_id(assignment_id)
        
        if not assignment:
            return False, "âŒ Assignment not found"
        
        submission_key = f"{assignment_id}_{student_id_str}"
        
        if submission_key in self.submissions:
            return False, "âŒ You have already received this assignment"
        
        # Create submission record
        submission = {
            "assignment_id": assignment_id,
            "student_id": student_id_str,
            "student_username": student_username,
            "received_at": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "status": "received",
            "submitted_at": None,
            "submission_text": None,
            "grade": None,
            "feedback": None,
            "graded": False,
            "graded_by": None,
            "graded_at": None
        }
        
        self.submissions[submission_key] = submission
        self.save_submissions()
        
        # Update assignment stats
        if "total_students" not in assignment:
            assignment["total_students"] = 0
        assignment["total_students"] += 1
        self.save_assignments()
        
        return True, f"âœ… Assignment received: {assignment['title']}"
    
    def submit_assignment(self, student_id, student_username, assignment_id, submission_text):
        """Student submits an assignment"""
        student_id_str = str(student_id)
        assignment = self.get_assignment_by_id(assignment_id)
        
        if not assignment:
            return False, "âŒ Assignment not found"
        
        submission_key = f"{assignment_id}_{student_id_str}"
        
        if submission_key not in self.submissions:
            return False, "âŒ You must first receive this assignment using /receive"
        
        submission = self.submissions[submission_key]
        
        if submission.get("status") == "submitted":
            return False, "âŒ You have already submitted this assignment"
        
        # Update submission
        submission["status"] = "submitted"
        submission["submitted_at"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        submission["submission_text"] = submission_text
        
        # Check if late submission
        due_date = datetime.strptime(assignment["due_date"], "%Y-%m-%d %H:%M:%S")
        submit_date = datetime.strptime(submission["submitted_at"], "%Y-%m-%d %H:%M:%S")
        
        if submit_date > due_date:
            submission["late_submission"] = True
            submission["days_late"] = (submit_date - due_date).days
        else:
            submission["late_submission"] = False
            submission["days_late"] = 0
        
        self.submissions[submission_key] = submission
        self.save_submissions()
        
        # Update assignment stats
        if "submitted" not in assignment:
            assignment["submitted"] = 0
        assignment["submitted"] += 1
        self.save_assignments()
        
        return True, f"âœ… Assignment submitted: {assignment['title']}"
    
    def get_teacher_inbox(self, teacher_id):
        """Get all submissions for a teacher"""
        teacher_submissions = []
        
        for submission_key, submission in self.submissions.items():
            assignment_id = submission["assignment_id"]
            assignment = self.get_assignment_by_id(assignment_id)
            
            if assignment and str(assignment["teacher_id"]) == str(teacher_id):
                # Add assignment details to submission
                submission_with_details = submission.copy()
                submission_with_details["assignment_title"] = assignment["title"]
                submission_with_details["assignment_subject"] = assignment["subject"]
                submission_with_details["due_date"] = assignment["due_date"]
                teacher_submissions.append(submission_with_details)
        
        return teacher_submissions
    
    def grade_submission(self, teacher_username, assignment_id, student_id, grade, feedback=""):
        """Grade a student's submission"""
        student_id_str = str(student_id)
        submission_key = f"{assignment_id}_{student_id_str}"
        
        if submission_key not in self.submissions:
            return False, "âŒ Submission not found"
        
        submission = self.submissions[submission_key]
        
        if submission["status"] != "submitted":
            return False, "âŒ Student has not submitted this assignment"
        
        # Update submission with grade
        submission["grade"] = grade
        submission["feedback"] = feedback
        submission["graded"] = True
        submission["graded_by"] = teacher_username
        submission["graded_at"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        self.submissions[submission_key] = submission
        self.save_submissions()
        
        # Update assignment stats
        assignment = self.get_assignment_by_id(assignment_id)
        if assignment:
            if "graded" not in assignment:
                assignment["graded"] = 0
            assignment["graded"] += 1
            self.save_assignments()
        
        return True, f"âœ… Grade recorded for student {student_id}"
    
    def get_student_grades(self, student_id):
        """Get all grades for a student"""
        student_id_str = str(student_id)
        grades = []
        
        for submission_key, submission in self.submissions.items():
            if submission["student_id"] == student_id_str and submission["graded"]:
                assignment_id = submission["assignment_id"]
                assignment = self.get_assignment_by_id(assignment_id)
                
                if assignment:
                    grade_entry = {
                        "assignment_title": assignment["title"],
                        "subject": assignment["subject"],
                        "grade": submission["grade"],
                        "feedback": submission["feedback"],
                        "graded_by": submission["graded_by"],
                        "graded_at": submission["graded_at"],
                        "submitted_at": submission["submitted_at"]
                    }
                    grades.append(grade_entry)
        
        return grades
    
    def get_assignment_stats(self, assignment_id):
        """Get statistics for an assignment"""
        assignment = self.get_assignment_by_id(assignment_id)
        if not assignment:
            return None
        
        stats = {
            "total_students": assignment.get("total_students", 0),
            "submitted": assignment.get("submitted", 0),
            "graded": assignment.get("graded", 0),
            "submission_rate": 0,
            "average_grade": 0,
            "late_submissions": 0
        }
        
        if stats["total_students"] > 0:
            stats["submission_rate"] = round((stats["submitted"] / stats["total_students"]) * 100, 1)
        
        # Calculate average grade and late submissions
        grades = []
        for submission_key, submission in self.submissions.items():
            if submission["assignment_id"] == assignment_id:
                if submission.get("late_submission"):
                    stats["late_submissions"] += 1
                if submission.get("grade"):
                    try:
                        grades.append(float(submission["grade"]))
                    except:
                        pass
        
        if grades:
            stats["average_grade"] = round(sum(grades) / len(grades), 1)
        
        return stats

# ===================== ATTENDANCE MANAGER =====================
class AttendanceManager:
    """Manage daily attendance"""
    
    def __init__(self):
        self.attendance = self.load_attendance()
    
    def load_attendance(self):
        """Load attendance from JSON file"""
        try:
            with open(ATTENDANCE_FILE, 'r') as f:
                return json.load(f)
        except FileNotFoundError:
            return {}
    
    def save_attendance(self):
        """Save attendance to JSON file"""
        with open(ATTENDANCE_FILE, 'w') as f:
            json.dump(self.attendance, f, indent=2)
    
    def mark_present(self, user_id, username, first_name, is_manual=False):
        """Mark user as present for today"""
        today = datetime.now().strftime("%Y-%m-%d")
        
        if today not in self.attendance:
            self.attendance[today] = {}
        
        if str(user_id) not in self.attendance[today]:
            self.attendance[today][str(user_id)] = {
                "username": username,
                "first_name": first_name,
                "time": datetime.now().strftime("%H:%M:%S"),
                "type": "manual" if is_manual else "profile",
                "status": "present"
            }
            self.save_attendance()
            return True, "âœ… You have been marked PRESENT for today!"
        else:
            return False, "ğŸ“ You are already marked present for today."
    
    def mark_absent_by_username(self, username):
        """Mark user as absent by username"""
        today = datetime.now().strftime("%Y-%m-%d")
        
        if today not in self.attendance:
            self.attendance[today] = {}
        
        # Create a unique ID for absent students
        user_id = f"absent_{username}_{int(datetime.now().timestamp())}"
        
        self.attendance[today][user_id] = {
            "username": username,
            "first_name": username,
            "time": datetime.now().strftime("%H:%M:%S"),
            "type": "manual_absent",
            "status": "absent"
        }
        self.save_attendance()
        
        return True, f"âœ… @{username} marked ABSENT for today"
    
    def mark_absent_by_id(self, user_id, username, first_name):
        """Mark user as absent by user ID"""
        today = datetime.now().strftime("%Y-%m-%d")
        
        if today not in self.attendance:
            self.attendance[today] = {}
        
        self.attendance[today][str(user_id)] = {
            "username": username,
            "first_name": first_name,
            "time": datetime.now().strftime("%H:%M:%S"),
            "type": "manual",
            "status": "absent"
        }
        self.save_attendance()
        
        return True, f"âœ… {first_name} (@{username}) marked ABSENT for today"
    
    def get_user_attendance(self, user_id):
        """Get user's attendance record"""
        user_id = str(user_id)
        records = []
        
        for date, day_data in self.attendance.items():
            if user_id in day_data:
                records.append({
                    "date": date,
                    "status": day_data[user_id]["status"],
                    "time": day_data[user_id]["time"],
                    "type": day_data[user_id].get("type", "unknown")
                })
        
        # Sort by date (newest first)
        records.sort(key=lambda x: x["date"], reverse=True)
        
        # Calculate statistics
        total_days = len(records)
        present_days = len([r for r in records if r["status"] == "present"])
        absent_days = len([r for r in records if r["status"] == "absent"])
        
        if total_days > 0:
            attendance_rate = (present_days / total_days) * 100
        else:
            attendance_rate = 0
        
        return {
            "records": records[:30],
            "total_days": total_days,
            "present_days": present_days,
            "absent_days": absent_days,
            "attendance_rate": round(attendance_rate, 1)
        }
    
    def get_daily_attendance(self, date_str=None):
        """Get attendance for a specific day"""
        if date_str is None:
            date_str = datetime.now().strftime("%Y-%m-%d")
        
        if date_str in self.attendance:
            return self.attendance[date_str]
        return {}

# ===================== USER MANAGER =====================
class UserManager:
    """Manage admins and teachers"""
    
    def __init__(self):
        self.admins = self.load_users(ADMINS_FILE)
        self.teachers = self.load_users(TEACHERS_FILE)
        
        # Ensure super admins are always in admin list
        super_admins = ["sh3ll_3xp10it", "dagi_tariku"]
        for admin in super_admins:
            if admin not in self.admins:
                self.admins.append(admin)
        self.save_admins()
    
    def load_users(self, filename):
        """Load user list from JSON file"""
        try:
            with open(filename, 'r') as f:
                return json.load(f)
        except FileNotFoundError:
            return []
    
    def save_users(self, users, filename):
        """Save user list to JSON file"""
        with open(filename, 'w') as f:
            json.dump(users, f, indent=2)
    
    def save_admins(self):
        self.save_users(self.admins, ADMINS_FILE)
    
    def save_teachers(self):
        self.save_users(self.teachers, TEACHERS_FILE)
    
    def is_super_admin(self, username):
        """Check if user is super admin"""
        super_admins = ["sh3ll_3xp10it", "dagi_tariku"]
        return username in super_admins if username else False
    
    def is_admin(self, username):
        """Check if user is admin"""
        return username in self.admins if username else False
    
    def is_teacher(self, username):
        """Check if user is teacher"""
        return username in self.teachers if username else False
    
    def add_admin(self, username):
        """Add new admin"""
        username = username.lower().replace("@", "")
        if username not in self.admins:
            self.admins.append(username)
            self.save_admins()
            return True
        return False
    
    def remove_admin(self, username):
        """Remove admin"""
        username = username.lower().replace("@", "")
        if username in self.admins and not self.is_super_admin(username):
            self.admins.remove(username)
            self.save_admins()
            return True
        return False
    
    def add_teacher(self, username):
        """Add new teacher"""
        username = username.lower().replace("@", "")
        if username not in self.teachers:
            self.teachers.append(username)
            self.save_teachers()
            return True
        return False
    
    def remove_teacher(self, username):
        """Remove teacher"""
        username = username.lower().replace("@", "")
        if username in self.teachers:
            self.teachers.remove(username)
            self.save_teachers()
            return True
        return False
    
    def get_all_admins(self):
        """Get all admins"""
        return self.admins
    
    def get_all_teachers(self):
        """Get all teachers"""
        return self.teachers

# ===================== MAIN BOT =====================
class AssignmentBot:
    """Main bot class with assignment system"""
    
    def __init__(self):
        self.bot = telebot.TeleBot(BOT_TOKEN, parse_mode='HTML')
        self.user_manager = UserManager()
        self.attendance = AttendanceManager()
        self.assignments = AssignmentManager()
        self.setup_handlers()
        
        print("=" * 60)
        print(f"ğŸ« {SCHOOL_NAME} - {GRADE}")
        print(f"ğŸ¤– Assignment Bot v3.2")
        print("=" * 60)
        print(f"ğŸ‘‘ Super Admins: @sh3ll_3xp10it, @dagi_tariku")
        print(f"ğŸ‘¨â€ğŸ’¼ Total Admins: {len(self.user_manager.admins)}")
        print(f"ğŸ‘¨â€ğŸ« Total Teachers: {len(self.user_manager.teachers)}")
        print("=" * 60)
    
    def setup_handlers(self):
        """Setup command handlers"""
        
        # ========== BASIC COMMANDS ==========
        @self.bot.message_handler(commands=['start', 'help'])
        def help_handler(message):
            """Help command"""
            user = message.from_user
            username = user.username
            
            if self.user_manager.is_admin(username):
                response = self._get_admin_help(username)
            elif self.user_manager.is_teacher(username):
                response = self._get_teacher_help(username)
            else:
                response = self._get_student_help()
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['rules'])
        def rules_handler(message):
            """Rules command"""
            rules = self._get_rules()
            self.bot.reply_to(message, rules)
        
        @self.bot.message_handler(commands=['about'])
        def about_handler(message):
            """About the bot"""
            response = (
                f"ğŸ¤– <b>ASPIRATION BOT</b>\n\n"
                f"ğŸ« {SCHOOL_NAME}\n"
                f"ğŸ“š {GRADE}\n\n"
                f"ğŸ“Š <b>Features:</b>\n"
                f"âœ… Daily Attendance System\n"
                f"ğŸ“š Assignment Management\n"
                f"ğŸ“¥ Student Submissions\n"
                f"ğŸ“ Grading System\n"
                f"ğŸ“Š Progress Tracking\n\n"
                f"ğŸ‘‘ <b>Super Admins:</b>\n"
                f"â€¢ @sh3ll_3xp10it\n"
                f"â€¢ @dagi_tariku\n\n"
                f"ğŸ“ <b>Support:</b> Contact system administrator"
            )
            self.bot.reply_to(message, response)
        
        # ========== ATTENDANCE COMMANDS ==========
        @self.bot.message_handler(commands=['profile'])
        def profile_handler(message):
            """Profile command - AUTO MARKS PRESENT"""
            user = message.from_user
            
            # AUTO MARK PRESENT when checking profile
            attendance_result = self.attendance.mark_present(
                user.id, 
                user.username, 
                user.first_name,
                is_manual=False
            )
            
            # Get user's attendance record
            user_attendance = self.attendance.get_user_attendance(user.id)
            
            # Get student assignments
            student_assignments = self.assignments.get_student_assignments(user.id)
            
            # Get student grades
            student_grades = self.assignments.get_student_grades(user.id)
            
            # Determine role
            username = user.username
            if self.user_manager.is_super_admin(username):
                role = "ğŸ‘‘ SUPER ADMIN"
            elif self.user_manager.is_admin(username):
                role = "ğŸ‘¨â€ğŸ’¼ ADMINISTRATOR"
            elif self.user_manager.is_teacher(username):
                role = "ğŸ‘¨â€ğŸ« TEACHER"
            else:
                role = "ğŸ‘¨â€ğŸ“ STUDENT"
            
            # Build profile response
            response = (
                f"ğŸ‘¤ <b>STUDENT PROFILE</b>\n"
                f"ğŸ« {SCHOOL_NAME} - {GRADE}\n\n"
                
                f"ğŸ“‹ <b>PERSONAL INFORMATION:</b>\n"
                f"â€¢ Name: {user.first_name} {user.last_name or ''}\n"
                f"â€¢ Username: @{username or 'Not set'}\n"
                f"â€¢ Role: {role}\n"
                f"â€¢ Student ID: <code>{user.id}</code>\n\n"
                
                f"ğŸ“Š <b>ATTENDANCE STATISTICS:</b>\n"
                f"â€¢ Total Days: {user_attendance['total_days']}\n"
                f"â€¢ Present Days: {user_attendance['present_days']}\n"
                f"â€¢ Attendance Rate: {user_attendance['attendance_rate']}%\n\n"
                
                f"ğŸ“š <b>ACADEMIC PERFORMANCE:</b>\n"
            )
            
            # Add assignment info
            active_assignments = len([a for a in student_assignments if not a.get("submitted")])
            submitted_assignments = len([a for a in student_assignments if a.get("submitted")])
            graded_assignments = len([a for a in student_assignments if a.get("graded")])
            
            response += f"â€¢ Active Assignments: {active_assignments}\n"
            response += f"â€¢ Submitted: {submitted_assignments}\n"
            response += f"â€¢ Graded: {graded_assignments}\n\n"
            
            # Add grades if available
            if student_grades:
                response += f"ğŸ“ <b>RECENT GRADES:</b>\n"
                for grade in student_grades[:3]:
                    response += f"â€¢ {grade['assignment_title']}: {grade['grade']}\n"
                response += "\n"
            
            # Add today's attendance status
            today = datetime.now().strftime("%Y-%m-%d")
            today_record = next((r for r in user_attendance['records'] if r['date'] == today), None)
            
            if today_record:
                response += f"âœ… <b>Today's Status:</b> PRESENT (Auto-recorded at {today_record['time']})\n\n"
            else:
                response += f"âš ï¸ <b>Today's Status:</b> NOT RECORDED\n\n"
            
            response += (
                f"ğŸ’¡ <b>QUICK ACTIONS:</b>\n"
                f"<code>/assignments</code> - View your assignments\n"
                f"<code>/submit</code> - Submit an assignment\n"
                f"<code>/grades</code> - View your grades\n"
                f"<code>/attendance</code> - View attendance record\n\n"
                
                f"ğŸ‘® <b>Super Admins:</b> @sh3ll_3xp10it, @dagi_tariku"
            )
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['attendance'])
        def attendance_handler(message):
            """View attendance"""
            user = message.from_user
            user_attendance = self.attendance.get_user_attendance(user.id)
            
            response = (
                f"ğŸ“‹ <b>ATTENDANCE RECORD</b>\n"
                f"ğŸ‘¤ {user.first_name} (@{user.username or 'No username'})\n\n"
                
                f"ğŸ“Š <b>STATISTICS:</b>\n"
                f"â€¢ Total Days: {user_attendance['total_days']}\n"
                f"â€¢ Present: {user_attendance['present_days']} days\n"
                f"â€¢ Rate: {user_attendance['attendance_rate']}%\n\n"
                
                f"ğŸ“… <b>RECENT ATTENDANCE:</b>\n"
            )
            
            for record in user_attendance['records'][:7]:
                status_icon = "âœ…" if record['status'] == 'present' else "âŒ"
                response += f"{status_icon} {record['date']}: {record['status'].title()}\n"
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['markpresent'])
        def mark_present_handler(message):
            """Manually mark present for today"""
            user = message.from_user
            success, result = self.attendance.mark_present(
                user.id, 
                user.username, 
                user.first_name,
                is_manual=True
            )
            self.bot.reply_to(message, result)
        
        # ========== MARK ABSENT COMMAND ==========
        @self.bot.message_handler(commands=['markabsent', 'markabsence', 'absent'])
        def mark_absent_handler(message):
            """Mark a student as absent (teachers/admins only)"""
            user = message.from_user
            username = user.username
            
            if not (self.user_manager.is_admin(username) or self.user_manager.is_teacher(username)):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only teachers and administrators can mark students absent."
                )
                return
            
            parts = message.text.split()
            if len(parts) < 2:
                self.bot.reply_to(message,
                    "ğŸ“ <b>MARK STUDENT ABSENT</b>\n\n"
                    "âš ï¸ <b>Usage:</b> <code>/markabsent [username]</code>\n\n"
                    "<b>Example:</b>\n"
                    "<code>/markabsent john_student</code>\n\n"
                    "ğŸ’¡ <b>Note:</b>\n"
                    "â€¢ Username without @ symbol\n"
                    "â€¢ Use /liststudents to see today's attendance"
                )
                return
            
            student_username = parts[1].replace("@", "").lower()
            
            # Mark absent
            success, result = self.attendance.mark_absent_by_username(student_username)
            
            if success:
                response = (
                    f"ğŸ“ <b>ABSENCE RECORDED</b>\n\n"
                    f"ğŸ‘¨â€ğŸ“ Student: @{student_username}\n"
                    f"ğŸ‘¨â€ğŸ« Marked by: @{username}\n"
                    f"ğŸ“… Date: {datetime.now().strftime('%Y-%m-%d')}\n"
                    f"ğŸ•’ Time: {datetime.now().strftime('%H:%M:%S')}\n\n"
                    f"ğŸ“Š Student has been marked ABSENT for today."
                )
            else:
                response = result
            
            self.bot.reply_to(message, response)
        
        # ========== IMPROVED: LIST STUDENTS COMMAND ==========
        @self.bot.message_handler(commands=['liststudents', 'students'])
        def list_students_handler(message):
            """List all students who have used the bot"""
            username = message.from_user.username
            
            if not (self.user_manager.is_admin(username) or self.user_manager.is_teacher(username)):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only teachers and administrators can view student list."
                )
                return
            
            # Get today's attendance
            today = datetime.now().strftime("%Y-%m-%d")
            today_attendance = self.attendance.get_daily_attendance(today)
            
            if not today_attendance:
                response = "ğŸ“­ No students recorded today."
            else:
                present = []
                absent = []
                
                for user_id, data in today_attendance.items():
                    # Get display name (use first_name if no username)
                    username_display = data.get("username", "")
                    first_name = data.get("first_name", "Unknown")
                    
                    # Handle cases where username is None or empty
                    if not username_display or username_display == "None" or username_display == "null":
                        if first_name and first_name != "Unknown":
                            display_name = f"{first_name} (No username)"
                        else:
                            display_name = "Unknown User"
                    else:
                        if username_display.startswith("@"):
                            display_name = username_display
                        else:
                            display_name = f"@{username_display}"
                    
                    student_info = {
                        "display": display_name,
                        "time": data.get("time", "Unknown"),
                        "first_name": first_name,
                        "username": username_display if username_display not in ["None", "null", ""] else "No username"
                    }
                    
                    if data.get("status") == "present":
                        present.append(student_info)
                    else:
                        absent.append(student_info)
                
                # Sort present students by time
                present.sort(key=lambda x: x.get("time", ""))
                
                response = (
                    f"ğŸ“Š <b>TODAY'S ATTENDANCE REPORT</b>\n"
                    f"ğŸ“… {today}\n\n"
                    
                    f"âœ… <b>PRESENT ({len(present)}):</b>\n"
                )
                
                # Show present students
                for i, student in enumerate(present[:20], 1):
                    time_display = f" - {student['time']}" if student.get('time') and student['time'] != "Unknown" else ""
                    response += f"{i}. {student['display']}{time_display}\n"
                
                if len(present) > 20:
                    response += f"... and {len(present)-20} more\n"
                
                # Show absent students
                response += f"\nâŒ <b>ABSENT ({len(absent)}):</b>\n"
                
                if absent:
                    for i, student in enumerate(absent[:10], 1):
                        time_display = f" - {student['time']}" if student.get('time') and student['time'] != "Unknown" else ""
                        response += f"{i}. {student['display']}{time_display}\n"
                    
                    if len(absent) > 10:
                        response += f"... and {len(absent)-10} more\n"
                else:
                    response += "ğŸ‰ No absent students today!\n"
                
                # Add statistics
                response += f"\nğŸ“ˆ <b>ATTENDANCE STATISTICS:</b>\n"
                response += f"â€¢ Total Students: {len(present) + len(absent)}\n"
                response += f"â€¢ Present: {len(present)} students\n"
                response += f"â€¢ Absent: {len(absent)} students\n"
                
                if (len(present) + len(absent)) > 0:
                    attendance_rate = (len(present) / (len(present) + len(absent))) * 100
                    response += f"â€¢ Attendance Rate: {attendance_rate:.1f}%\n"
                
                response += f"\nâ° Report generated: {datetime.now().strftime('%H:%M:%S')}"
            
            self.bot.reply_to(message, response)
        
        # ========== ADMIN MANAGEMENT COMMANDS ==========
        @self.bot.message_handler(commands=['addadmin'])
        def add_admin_handler(message):
            """Add new admin (super admins only)"""
            username = message.from_user.username
            
            if not self.user_manager.is_super_admin(username):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only super admins can add new administrators."
                )
                return
            
            parts = message.text.split()
            if len(parts) < 2:
                self.bot.reply_to(message,
                    "ğŸ‘‘ <b>ADD ADMINISTRATOR</b>\n\n"
                    "âš ï¸ <b>Usage:</b> <code>/addadmin [username]</code>\n\n"
                    "<b>Example:</b>\n"
                    "<code>/addadmin john_doe</code>\n\n"
                    "ğŸ’¡ <b>Note:</b> Username without @ symbol"
                )
                return
            
            new_admin = parts[1]
            if self.user_manager.add_admin(new_admin):
                response = (
                    f"âœ… <b>NEW ADMIN ADDED</b>\n\n"
                    f"ğŸ‘¨â€ğŸ’¼ Username: @{new_admin}\n"
                    f"ğŸ‘‘ Added by: @{username}\n"
                    f"ğŸ“… Date: {datetime.now().strftime('%Y-%m-%d')}\n\n"
                    f"Total Admins: {len(self.user_manager.admins)}"
                )
            else:
                response = f"âš ï¸ @{new_admin} is already an administrator."
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['removeadmin'])
        def remove_admin_handler(message):
            """Remove admin (super admins only)"""
            username = message.from_user.username
            
            if not self.user_manager.is_super_admin(username):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only super admins can remove administrators."
                )
                return
            
            parts = message.text.split()
            if len(parts) < 2:
                self.bot.reply_to(message,
                    "ğŸ‘‘ <b>REMOVE ADMINISTRATOR</b>\n\n"
                    "âš ï¸ <b>Usage:</b> <code>/removeadmin [username]</code>\n\n"
                    "<b>Example:</b>\n"
                    "<code>/removeadmin john_doe</code>"
                )
                return
            
            admin_to_remove = parts[1]
            if self.user_manager.remove_admin(admin_to_remove):
                response = (
                    f"âœ… <b>ADMIN REMOVED</b>\n\n"
                    f"ğŸ‘¨â€ğŸ’¼ Username: @{admin_to_remove}\n"
                    f"ğŸ‘‘ Removed by: @{username}\n"
                    f"ğŸ“… Date: {datetime.now().strftime('%Y-%m-%d')}\n\n"
                    f"Remaining Admins: {len(self.user_manager.admins)}"
                )
            else:
                response = f"âš ï¸ Cannot remove @{admin_to_remove}. They might be a super admin or not in the list."
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['addteacher'])
        def add_teacher_handler(message):
            """Add new teacher (admins only)"""
            username = message.from_user.username
            
            if not (self.user_manager.is_admin(username) or self.user_manager.is_super_admin(username)):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only administrators can add new teachers."
                )
                return
            
            parts = message.text.split()
            if len(parts) < 2:
                self.bot.reply_to(message,
                    "ğŸ‘¨â€ğŸ« <b>ADD TEACHER</b>\n\n"
                    "âš ï¸ <b>Usage:</b> <code>/addteacher [username]</code>\n\n"
                    "<b>Example:</b>\n"
                    "<code>/addteacher math_teacher</code>\n\n"
                    "ğŸ’¡ <b>Note:</b> Username without @ symbol"
                )
                return
            
            new_teacher = parts[1]
            if self.user_manager.add_teacher(new_teacher):
                response = (
                    f"âœ… <b>NEW TEACHER ADDED</b>\n\n"
                    f"ğŸ‘¨â€ğŸ« Username: @{new_teacher}\n"
                    f"ğŸ‘‘ Added by: @{username}\n"
                    f"ğŸ“… Date: {datetime.now().strftime('%Y-%m-%d')}\n\n"
                    f"Total Teachers: {len(self.user_manager.teachers)}"
                )
            else:
                response = f"âš ï¸ @{new_teacher} is already a teacher."
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['removeteacher'])
        def remove_teacher_handler(message):
            """Remove teacher (admins only)"""
            username = message.from_user.username
            
            if not (self.user_manager.is_admin(username) or self.user_manager.is_super_admin(username)):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only administrators can remove teachers."
                )
                return
            
            parts = message.text.split()
            if len(parts) < 2:
                self.bot.reply_to(message,
                    "ğŸ‘¨â€ğŸ« <b>REMOVE TEACHER</b>\n\n"
                    "âš ï¸ <b>Usage:</b> <code>/removeteacher [username]</code>\n\n"
                    "<b>Example:</b>\n"
                    "<code>/removeteacher math_teacher</code>"
                )
                return
            
            teacher_to_remove = parts[1]
            if self.user_manager.remove_teacher(teacher_to_remove):
                response = (
                    f"âœ… <b>TEACHER REMOVED</b>\n\n"
                    f"ğŸ‘¨â€ğŸ« Username: @{teacher_to_remove}\n"
                    f"ğŸ‘‘ Removed by: @{username}\n"
                    f"ğŸ“… Date: {datetime.now().strftime('%Y-%m-%d')}\n\n"
                    f"Remaining Teachers: {len(self.user_manager.teachers)}"
                )
            else:
                response = f"âš ï¸ @{teacher_to_remove} is not in the teacher list."
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['listadmins'])
        def list_admins_handler(message):
            """List all admins"""
            username = message.from_user.username
            
            if not (self.user_manager.is_admin(username) or self.user_manager.is_teacher(username)):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only administrators and teachers can view this list."
                )
                return
            
            admins = self.user_manager.get_all_admins()
            
            response = f"ğŸ‘‘ <b>SYSTEM ADMINISTRATORS</b>\n\n"
            
            for i, admin in enumerate(admins, 1):
                status = "SUPER ADMIN" if self.user_manager.is_super_admin(admin) else "ADMIN"
                response += f"{i}. @{admin} - {status}\n"
            
            response += f"\nğŸ“Š Total: {len(admins)} administrators"
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['listteachers'])
        def list_teachers_handler(message):
            """List all teachers"""
            username = message.from_user.username
            
            if not (self.user_manager.is_admin(username) or self.user_manager.is_teacher(username)):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only administrators and teachers can view this list."
                )
                return
            
            teachers = self.user_manager.get_all_teachers()
            
            response = f"ğŸ‘¨â€ğŸ« <b>TEACHERS LIST</b>\n\n"
            
            for i, teacher in enumerate(teachers, 1):
                response += f"{i}. @{teacher}\n"
            
            response += f"\nğŸ“Š Total: {len(teachers)} teachers"
            
            self.bot.reply_to(message, response)
        
        # ========== ASSIGNMENT COMMANDS ==========
        @self.bot.message_handler(commands=['createassignment', 'newassignment'])
        def create_assignment_handler(message):
            """Create new assignment (teachers only)"""
            username = message.from_user.username
            
            if not (self.user_manager.is_admin(username) or self.user_manager.is_teacher(username)):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only teachers and administrators can create assignments."
                )
                return
            
            parts = message.text.split(maxsplit=4)
            if len(parts) < 5:
                self.bot.reply_to(message,
                    "ğŸ“ <b>CREATE ASSIGNMENT</b>\n\n"
                    "âš ï¸ <b>Usage:</b> <code>/createassignment [subject] [title] [due_date] [description]</code>\n\n"
                    "<b>Example:</b>\n"
                    "<code>/createassignment Mathematics Algebra 2024-02-10 Solve equations 1-10 from textbook</code>\n\n"
                    "<b>Date format:</b> YYYY-MM-DD (e.g., 2024-02-10)"
                )
                return
            
            subject = parts[1]
            title = parts[2]
            due_date_str = parts[3]
            description = parts[4]
            
            # Parse due date
            try:
                due_date = datetime.strptime(due_date_str, "%Y-%m-%d")
                due_date = due_date.replace(hour=23, minute=59, second=59)
            except ValueError:
                self.bot.reply_to(message,
                    "âŒ <b>INVALID DATE FORMAT</b>\n\n"
                    "Please use YYYY-MM-DD format\n"
                    "Example: 2024-02-10"
                )
                return
            
            # Create assignment
            assignment_id, assignment = self.assignments.create_assignment(
                message.from_user.id,
                username,
                subject,
                title,
                description,
                due_date.strftime("%Y-%m-%d %H:%M:%S")
            )
            
            response = (
                f"ğŸ“š <b>NEW ASSIGNMENT CREATED</b>\n\n"
                f"ğŸ“ <b>Title:</b> {title}\n"
                f"ğŸ“š <b>Subject:</b> {subject}\n"
                f"ğŸ‘¨â€ğŸ« <b>Teacher:</b> @{username}\n"
                f"ğŸ“… <b>Due Date:</b> {due_date_str}\n"
                f"ğŸ“‹ <b>Description:</b>\n{description}\n\n"
                f"ğŸ†” <b>Assignment ID:</b> <code>{assignment_id}</code>\n\n"
                f"ğŸ‘¨â€ğŸ“ <b>STUDENTS:</b> Use <code>/receive {assignment_id}</code> to receive this assignment\n"
                f"ğŸ‘¨â€ğŸ« <b>TEACHERS:</b> Use <code>/assignmentstats {assignment_id}</code> to view statistics"
            )
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['assignments', 'myassignments'])
        def assignments_handler(message):
            """View student assignments"""
            user = message.from_user
            student_assignments = self.assignments.get_student_assignments(user.id)
            
            if not student_assignments:
                response = (
                    f"ğŸ“š <b>MY ASSIGNMENTS</b>\n\n"
                    f"ğŸ“­ No assignments found.\n\n"
                    f"ğŸ’¡ <b>How it works:</b>\n"
                    f"1. Teachers create assignments\n"
                    f"2. Use <code>/receive [id]</code> to receive\n"
                    f"3. Use <code>/submit [id] [work]</code> to submit\n"
                    f"4. Check grades with <code>/grades</code>"
                )
            else:
                response = f"ğŸ“š <b>MY ASSIGNMENTS</b>\n\n"
                
                # Group by status
                pending = [a for a in student_assignments if not a.get("submitted")]
                submitted = [a for a in student_assignments if a.get("submitted") and not a.get("graded")]
                graded = [a for a in student_assignments if a.get("graded")]
                
                if pending:
                    response += f"â³ <b>PENDING ({len(pending)}):</b>\n"
                    for assignment in pending[:3]:
                        response += f"â€¢ {assignment['title']} (Due: {assignment['due_date'][:10]})\n"
                        response += f"  ID: <code>{assignment['assignment_id']}</code>\n"
                    if len(pending) > 3:
                        response += f"  ... and {len(pending)-3} more\n"
                    response += "\n"
                
                if submitted:
                    response += f"ğŸ“¤ <b>SUBMITTED ({len(submitted)}):</b>\n"
                    for assignment in submitted[:2]:
                        response += f"â€¢ {assignment['title']} (Submitted: {assignment['submission_time'][:10]})\n"
                    response += "\n"
                
                if graded:
                    response += f"ğŸ“ <b>GRADED ({len(graded)}):</b>\n"
                    for assignment in graded[:3]:
                        grade = assignment.get('grade', 'N/A')
                        response += f"â€¢ {assignment['title']}: {grade}\n"
                    response += "\n"
                
                response += (
                    f"ğŸ“Š <b>QUICK ACTIONS:</b>\n"
                    f"<code>/receive [id]</code> - Receive an assignment\n"
                    f"<code>/submit [id] [work]</code> - Submit assignment\n"
                    f"<code>/grades</code> - View all grades\n"
                )
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['receive'])
        def receive_handler(message):
            """Student receives an assignment"""
            user = message.from_user
            
            parts = message.text.split()
            if len(parts) < 2:
                self.bot.reply_to(message,
                    "ğŸ“¥ <b>RECEIVE ASSIGNMENT</b>\n\n"
                    "âš ï¸ <b>Usage:</b> <code>/receive [assignment_id]</code>\n\n"
                    "<b>Example:</b>\n"
                    "<code>/receive 1234567890</code>\n\n"
                    "ğŸ’¡ <b>Find assignment IDs in /assignments</b>"
                )
                return
            
            assignment_id = parts[1]
            success, result = self.assignments.receive_assignment(
                user.id,
                user.username,
                assignment_id
            )
            
            if success:
                assignment = self.assignments.get_assignment_by_id(assignment_id)
                response = (
                    f"ğŸ“¥ <b>ASSIGNMENT RECEIVED</b>\n\n"
                    f"{result}\n\n"
                    f"ğŸ“ <b>Details:</b>\n"
                    f"â€¢ Title: {assignment['title']}\n"
                    f"â€¢ Subject: {assignment['subject']}\n"
                    f"â€¢ Due Date: {assignment['due_date'][:10]}\n"
                    f"â€¢ Teacher: @{assignment['teacher_username']}\n\n"
                    f"ğŸ“‹ <b>Next Step:</b> Complete and submit using:\n"
                    f"<code>/submit {assignment_id} [your work]</code>\n\n"
                    f"ğŸ’¡ <b>Example:</b>\n"
                    f"<code>/submit {assignment_id} I have completed all questions</code>"
                )
            else:
                response = result
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['submit', 'finished'])
        def submit_handler(message):
            """Student submits an assignment"""
            user = message.from_user
            
            parts = message.text.split(maxsplit=2)
            if len(parts) < 3:
                self.bot.reply_to(message,
                    "ğŸ“¤ <b>SUBMIT ASSIGNMENT</b>\n\n"
                    "âš ï¸ <b>Usage:</b> <code>/submit [assignment_id] [your work]</code>\n\n"
                    "<b>Example:</b>\n"
                    "<code>/submit 1234567890 I have completed all problems from chapter 5</code>\n\n"
                    "ğŸ’¡ <b>Notes:</b>\n"
                    "â€¢ First receive assignment with /receive\n"
                    "â€¢ Describe your work clearly\n"
                    "â€¢ Submit before due date"
                )
                return
            
            assignment_id = parts[1]
            submission_text = parts[2]
            
            success, result = self.assignments.submit_assignment(
                user.id,
                user.username,
                assignment_id,
                submission_text
            )
            
            if success:
                assignment = self.assignments.get_assignment_by_id(assignment_id)
                
                # Check if late
                due_date = datetime.strptime(assignment["due_date"], "%Y-%m-%d %H:%M:%S")
                submit_date = datetime.now()
                
                if submit_date > due_date:
                    days_late = (submit_date - due_date).days
                    late_note = f"â° <b>LATE SUBMISSION:</b> {days_late} days late\n\n"
                else:
                    late_note = "âœ… <b>ON TIME SUBMISSION</b>\n\n"
                
                response = (
                    f"ğŸ“¤ <b>ASSIGNMENT SUBMITTED</b>\n\n"
                    f"{late_note}"
                    f"{result}\n\n"
                    f"ğŸ“ <b>Details:</b>\n"
                    f"â€¢ Student: {user.first_name} (@{user.username})\n"
                    f"â€¢ Assignment: {assignment['title']}\n"
                    f"â€¢ Subject: {assignment['subject']}\n"
                    f"â€¢ Submission: {submission_text[:100]}...\n"
                    f"â€¢ Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
                    f"ğŸ‘¨â€ğŸ« <b>Submitted to:</b> @{assignment['teacher_username']}\n"
                    f"ğŸ“¬ Teacher will grade and provide feedback\n\n"
                    f"ğŸ“Š <b>Check grades with:</b> <code>/grades</code>"
                )
            else:
                response = result
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['inbox', 'mysubmissions'])
        def inbox_handler(message):
            """Teacher views submission inbox"""
            username = message.from_user.username
            
            if not (self.user_manager.is_admin(username) or self.user_manager.is_teacher(username)):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only teachers and administrators can view submissions inbox."
                )
                return
            
            teacher_submissions = self.assignments.get_teacher_inbox(message.from_user.id)
            
            if not teacher_submissions:
                response = (
                    f"ğŸ“¬ <b>TEACHER INBOX</b>\n\n"
                    f"ğŸ“­ No submissions yet.\n\n"
                    f"ğŸ’¡ <b>How it works:</b>\n"
                    f"1. Create assignments with /createassignment\n"
                    f"2. Students submit with /submit\n"
                    f"3. View and grade submissions here\n"
                    f"4. Provide feedback to students"
                )
            else:
                # Group by status
                pending = [s for s in teacher_submissions if s["status"] == "submitted" and not s["graded"]]
                graded = [s for s in teacher_submissions if s["graded"]]
                received = [s for s in teacher_submissions if s["status"] == "received"]
                
                response = f"ğŸ“¬ <b>TEACHER INBOX</b>\nğŸ‘¨â€ğŸ« @{username}\n\n"
                
                if pending:
                    response += f"â³ <b>PENDING GRADING ({len(pending)}):</b>\n"
                    for sub in pending[:3]:
                        response += f"â€¢ {sub['student_username']}: {sub['assignment_title']}\n"
                        response += f"  ID: <code>{sub['assignment_id']}_{sub['student_id']}</code>\n"
                    if len(pending) > 3:
                        response += f"  ... and {len(pending)-3} more\n"
                    response += "\n"
                
                if graded:
                    response += f"âœ… <b>GRADED ({len(graded)}):</b>\n"
                    for sub in graded[:2]:
                        response += f"â€¢ {sub['student_username']}: {sub['assignment_title']} - {sub.get('grade', 'N/A')}\n"
                    response += "\n"
                
                if received:
                    response += f"ğŸ“¥ <b>RECEIVED ({len(received)}):</b>\n"
                    response += f"{len(received)} students received assignments\n\n"
                
                response += (
                    f"ğŸ“ <b>GRADE A SUBMISSION:</b>\n"
                    f"<code>/grade [assignment_id] [student_id] [grade] [feedback]</code>\n\n"
                    f"<b>Example:</b>\n"
                    f"<code>/grade 1234567890 987654321 85 Good work!</code>\n\n"
                    f"ğŸ“Š <b>View assignment statistics:</b>\n"
                    f"<code>/assignmentstats [assignment_id]</code>"
                )
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['grade'])
        def grade_handler(message):
            """Teacher grades a submission"""
            username = message.from_user.username
            
            if not (self.user_manager.is_admin(username) or self.user_manager.is_teacher(username)):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only teachers and administrators can grade submissions."
                )
                return
            
            parts = message.text.split(maxsplit=4)
            if len(parts) < 4:
                self.bot.reply_to(message,
                    "ğŸ“ <b>GRADE SUBMISSION</b>\n\n"
                    "âš ï¸ <b>Usage:</b> <code>/grade [assignment_id] [student_id] [grade] [feedback]</code>\n\n"
                    "<b>Example:</b>\n"
                    "<code>/grade 1234567890 987654321 85 Excellent work!</code>\n\n"
                    "ğŸ’¡ <b>Note:</b> Feedback is optional"
                )
                return
            
            assignment_id = parts[1]
            student_id = parts[2]
            grade = parts[3]
            feedback = parts[4] if len(parts) > 4 else ""
            
            success, result = self.assignments.grade_submission(
                username,
                assignment_id,
                student_id,
                grade,
                feedback
            )
            
            if success:
                # Get student info
                student_submissions = self.assignments.get_teacher_inbox(message.from_user.id)
                student_info = None
                for sub in student_submissions:
                    if sub["student_id"] == student_id and sub["assignment_id"] == assignment_id:
                        student_info = sub
                        break
                
                response = (
                    f"ğŸ“ <b>GRADE RECORDED</b>\n\n"
                    f"âœ… {result}\n\n"
                    f"ğŸ“Š <b>Details:</b>\n"
                )
                
                if student_info:
                    response += f"â€¢ Student: @{student_info['student_username']}\n"
                    response += f"â€¢ Assignment: {student_info['assignment_title']}\n"
                
                response += f"â€¢ Grade: {grade}\n"
                
                if feedback:
                    response += f"â€¢ Feedback: {feedback}\n"
                
                response += f"â€¢ Graded by: @{username}\n"
                response += f"â€¢ Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
            else:
                response = result
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['grades'])
        def grades_handler(message):
            """View student grades"""
            user = message.from_user
            student_grades = self.assignments.get_student_grades(user.id)
            
            if not student_grades:
                response = (
                    f"ğŸ“ <b>MY GRADES</b>\n\n"
                    f"ğŸ“­ No grades recorded yet.\n\n"
                    f"ğŸ’¡ <b>How it works:</b>\n"
                    f"1. Submit assignments using /submit\n"
                    f"2. Teachers grade your work\n"
                    f"3. Grades appear here with feedback\n\n"
                    f"ğŸ“Š <b>Current Status:</b>\n"
                    f"â€¢ Check assignments: <code>/assignments</code>\n"
                    f"â€¢ Submit work: <code>/submit</code>"
                )
            else:
                # Calculate average grade
                total_grade = 0
                valid_grades = 0
                
                for grade_entry in student_grades:
                    try:
                        grade_value = float(grade_entry["grade"])
                        total_grade += grade_value
                        valid_grades += 1
                    except:
                        pass
                
                average_grade = total_grade / valid_grades if valid_grades > 0 else 0
                
                response = (
                    f"ğŸ“ <b>ACADEMIC RECORD</b>\n"
                    f"ğŸ‘¤ {user.first_name} (@{user.username or 'No username'})\n\n"
                    
                    f"ğŸ“Š <b>OVERALL PERFORMANCE:</b>\n"
                    f"â€¢ Total Assignments: {len(student_grades)}\n"
                    f"â€¢ Average Grade: {average_grade:.1f}\n\n"
                    
                    f"ğŸ“‹ <b>GRADE BREAKDOWN:</b>\n"
                )
                
                for grade_entry in student_grades[:5]:
                    grade_value = grade_entry.get("grade", "N/A")
                    response += f"ğŸ“š {grade_entry['assignment_title']}: {grade_value}\n"
                    if grade_entry.get("feedback"):
                        response += f"   ğŸ’¬ {grade_entry['feedback'][:50]}...\n"
                
                if len(student_grades) > 5:
                    response += f"\nğŸ“– ... and {len(student_grades) - 5} more assignments\n"
                
                response += f"\nğŸ“… Last updated: {datetime.now().strftime('%Y-%m-%d')}"
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['assignmentstats'])
        def assignment_stats_handler(message):
            """View assignment statistics"""
            username = message.from_user.username
            
            if not (self.user_manager.is_admin(username) or self.user_manager.is_teacher(username)):
                self.bot.reply_to(message,
                    "ğŸš« <b>ACCESS DENIED</b>\n\n"
                    "Only teachers and administrators can view assignment statistics."
                )
                return
            
            parts = message.text.split()
            if len(parts) < 2:
                self.bot.reply_to(message,
                    "ğŸ“Š <b>ASSIGNMENT STATISTICS</b>\n\n"
                    "âš ï¸ <b>Usage:</b> <code>/assignmentstats [assignment_id]</code>\n\n"
                    "<b>Example:</b>\n"
                    "<code>/assignmentstats 1234567890</code>\n\n"
                    "ğŸ’¡ <b>Get assignment IDs from your created assignments</b>"
                )
                return
            
            assignment_id = parts[1]
            stats = self.assignments.get_assignment_stats(assignment_id)
            
            if not stats:
                response = "âŒ Assignment not found or no statistics available."
            else:
                assignment = self.assignments.get_assignment_by_id(assignment_id)
                
                response = (
                    f"ğŸ“Š <b>ASSIGNMENT STATISTICS</b>\n\n"
                    f"ğŸ“ <b>Title:</b> {assignment['title']}\n"
                    f"ğŸ“š <b>Subject:</b> {assignment['subject']}\n"
                    f"ğŸ‘¨â€ğŸ« <b>Teacher:</b> @{assignment['teacher_username']}\n"
                    f"ğŸ“… <b>Due Date:</b> {assignment['due_date'][:10]}\n\n"
                    
                    f"ğŸ“ˆ <b>PERFORMANCE METRICS:</b>\n"
                    f"â€¢ Total Students: {stats['total_students']}\n"
                    f"â€¢ Submitted: {stats['submitted']}\n"
                    f"â€¢ Graded: {stats['graded']}\n"
                    f"â€¢ Submission Rate: {stats['submission_rate']}%\n"
                    f"â€¢ Late Submissions: {stats['late_submissions']}\n"
                    f"â€¢ Average Grade: {stats['average_grade']}\n\n"
                )
                
                if stats['total_students'] > 0:
                    pending = stats['total_students'] - stats['submitted']
                    response += f"â³ <b>Pending Submissions:</b> {pending}\n"
                
                response += f"\nğŸ†” Assignment ID: <code>{assignment_id}</code>"
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(commands=['status'])
        def status_handler(message):
            """View bot status"""
            user = message.from_user
            username = user.username
            
            # Count data
            total_assignments = len(self.assignments.assignments)
            active_assignments = len(self.assignments.get_active_assignments())
            total_submissions = len(self.assignments.submissions)
            
            # Today's attendance
            today = datetime.now().strftime("%Y-%m-%d")
            today_attendance = self.attendance.get_daily_attendance(today)
            
            response = (
                f"ğŸ“Š <b>SYSTEM STATUS</b>\n"
                f"ğŸ« {SCHOOL_NAME} - {GRADE}\n\n"
                
                f"ğŸ‘¥ <b>USER STATISTICS:</b>\n"
                f"â€¢ Administrators: {len(self.user_manager.admins)}\n"
                f"â€¢ Teachers: {len(self.user_manager.teachers)}\n\n"
                
                f"ğŸ“š <b>ACADEMIC STATISTICS:</b>\n"
                f"â€¢ Total Assignments: {total_assignments}\n"
                f"â€¢ Active Assignments: {active_assignments}\n"
                f"â€¢ Total Submissions: {total_submissions}\n\n"
                
                f"ğŸ“… <b>TODAY'S ATTENDANCE:</b>\n"
                f"â€¢ Date: {today}\n"
                f"â€¢ Present Today: {len([x for x in today_attendance.values() if x['status'] == 'present'])}\n"
                f"â€¢ Absent Today: {len([x for x in today_attendance.values() if x['status'] == 'absent'])}\n\n"
                
                f"ğŸ‘¤ <b>YOUR ROLE:</b>\n"
            )
            
            if self.user_manager.is_super_admin(username):
                response += f"â€¢ ğŸ‘‘ SUPER ADMINISTRATOR\n"
            elif self.user_manager.is_admin(username):
                response += f"â€¢ ğŸ‘¨â€ğŸ’¼ ADMINISTRATOR\n"
            elif self.user_manager.is_teacher(username):
                response += f"â€¢ ğŸ‘¨â€ğŸ« TEACHER\n"
            else:
                response += f"â€¢ ğŸ‘¨â€ğŸ“ STUDENT\n"
            
            response += f"\nğŸ•’ Last updated: {datetime.now().strftime('%H:%M:%S')}"
            
            self.bot.reply_to(message, response)
        
        @self.bot.message_handler(func=lambda message: True)
        def handle_all_messages(message):
            """Handle all other messages"""
            if message.text.lower() in ['hi', 'hello', 'hey']:
                self.bot.reply_to(message,
                    f"ğŸ‘‹ Hello {message.from_user.first_name}!\n"
                    f"Welcome to {SCHOOL_NAME} {GRADE}.\n\n"
                    f"Type /help to see available commands."
                )
    
    # ===================== HELPER METHODS =====================
    def _get_admin_help(self, username):
        """Get help message for admins"""
        return (
            f"ğŸ‘‘ <b>ADMINISTRATOR PANEL</b>\n"
            f"Welcome @{username}\n\n"
            
            f"ğŸ“š <b>ACADEMIC MANAGEMENT:</b>\n"
            f"<code>/createassignment</code> - Create new assignment\n"
            f"<code>/inbox</code> - View student submissions\n"
            f"<code>/grade</code> - Grade student work\n"
            f"<code>/assignmentstats</code> - View assignment statistics\n\n"
            
            f"ğŸ“Š <b>ATTENDANCE MANAGEMENT:</b>\n"
            f"<code>/markabsent @username</code> - Mark student absent\n"
            f"<code>/liststudents</code> - View today's attendance\n\n"
            
            f"ğŸ‘¥ <b>USER MANAGEMENT:</b>\n"
            f"<code>/addteacher</code> - Add new teacher\n"
            f"<code>/removeteacher</code> - Remove teacher\n"
            f"<code>/listadmins</code> - List all admins\n"
            f"<code>/listteachers</code> - List all teachers\n\n"
            
            f"ğŸ“Š <b>SYSTEM COMMANDS:</b>\n"
            f"<code>/profile</code> - View profile & mark attendance\n"
            f"<code>/status</code> - View system status\n"
            f"<code>/attendance</code> - View attendance record\n\n"
            
            f"ğŸ‘‘ <b>SUPER ADMIN ONLY:</b>\n"
            f"<code>/addadmin</code> - Add new admin\n"
            f"<code>/removeadmin</code> - Remove admin\n\n"
            
            f"ğŸ’¡ <b>Tip:</b> Use /rules to see school rules"
        )
    
    def _get_teacher_help(self, username):
        """Get help message for teachers"""
        return (
            f"ğŸ‘¨â€ğŸ« <b>TEACHER PANEL</b>\n"
            f"Welcome @{username}\n\n"
            
            f"ğŸ“š <b>ASSIGNMENT MANAGEMENT:</b>\n"
            f"<code>/createassignment</code> - Create new assignment\n"
            f"<code>/inbox</code> - View student submissions\n"
            f"<code>/grade</code> - Grade student work\n"
            f"<code>/assignmentstats</code> - View assignment statistics\n\n"
            
            f"ğŸ“Š <b>ATTENDANCE MANAGEMENT:</b>\n"
            f"<code>/markabsent @username</code> - Mark student absent\n"
            f"<code>/liststudents</code> - View today's attendance\n\n"
            
            f"ğŸ‘¥ <b>USER MANAGEMENT:</b>\n"
            f"<code>/listteachers</code> - List all teachers\n"
            f"<code>/status</code> - View system status\n\n"
            
            f"ğŸ‘¤ <b>PERSONAL COMMANDS:</b>\n"
            f"<code>/profile</code> - View profile & mark attendance\n"
            f"<code>/attendance</code> - View attendance record\n\n"
            
            f"ğŸ’¡ <b>How it works:</b>\n"
            f"1. Create assignments for students\n"
            f"2. Students submit their work\n"
            f"3. Grade and provide feedback\n"
            f"4. Track student progress\n\n"
            
            f"ğŸ“ <b>Contact admins for support</b>"
        )
    
    def _get_student_help(self):
        """Get help message for students"""
        return (
            f"ğŸ‘¨â€ğŸ“ <b>STUDENT PANEL</b>\n"
            f"Welcome to {SCHOOL_NAME} {GRADE}\n\n"
            
            f"ğŸ“š <b>ASSIGNMENT SYSTEM:</b>\n"
            f"<code>/assignments</code> - View your assignments\n"
            f"<code>/receive [id]</code> - Receive an assignment\n"
            f"<code>/submit [id] [work]</code> - Submit completed work\n"
            f"<code>/grades</code> - View your grades\n\n"
            
            f"ğŸ“Š <b>ATTENDANCE SYSTEM:</b>\n"
            f"<code>/profile</code> - View profile & AUTO mark present\n"
            f"<code>/attendance</code> - View attendance record\n"
            f"<code>/markpresent</code> - Manually mark present\n\n"
            
            f"â„¹ï¸ <b>INFORMATION:</b>\n"
            f"<code>/about</code> - About this bot\n"
            f"<code>/rules</code> - School rules\n"
            f"<code>/status</code> - System status\n\n"
            
            f"ğŸ’¡ <b>How it works:</b>\n"
            f"1. Check /profile daily (auto attendance)\n"
            f"2. View assignments with /assignments\n"
            f"3. Receive assignments with /receive\n"
            f"4. Submit work with /submit\n"
            f"5. Check grades with /grades\n\n"
            
            f"ğŸ“ <b>Contact teachers for help with assignments</b>"
        )
    
    def _get_rules(self):
        """Get school rules"""
        return (
            f"ğŸ“œ <b>SCHOOL RULES - {SCHOOL_NAME}</b>\n\n"
            
            f"ğŸ« <b>ATTENDANCE POLICY:</b>\n"
            f"â€¢ Use /profile daily to mark attendance\n"
            f"â€¢ Minimum 80% attendance required\n"
            f"â€¢ Report absences to administration\n\n"
            
            f"ğŸ“š <b>ASSIGNMENT POLICY:</b>\n"
            f"â€¢ Submit assignments before deadline\n"
            f"â€¢ Use /receive before submitting\n"
            f"â€¢ Late submissions may affect grades\n"
            f"â€¢ Plagiarism is strictly prohibited\n\n"
            
            f"ğŸ‘¥ <b>BEHAVIOR POLICY:</b>\n"
            f"â€¢ Respect teachers and classmates\n"
            f"â€¢ Maintain academic integrity\n"
            f"â€¢ Follow all instructions carefully\n"
            f"â€¢ Report issues to administrators\n\n"
            
            f"ğŸ’» <b>TECHNICAL RULES:</b>\n"
            f"â€¢ Keep your Telegram account secure\n"
            f"â€¢ Don't share assignment IDs\n"
            f"â€¢ Report technical issues\n"
            f"â€¢ Save your student ID for reference\n\n"
            
            f"ğŸ‘‘ <b>Super Admins:</b> @sh3ll_3xp10it, @dagi_tariku\n"
            f"ğŸ“ Contact for rule clarification"
        )
    
    def run(self):
        """Start the bot"""
        print("ğŸ¤– Bot is running...")
        print("ğŸ”„ Waiting for messages...")
        print("=" * 60)
        self.bot.infinity_polling()

# ===================== MAIN ENTRY POINT =====================
if __name__ == "__main__":
    # Create necessary files if they don't exist
    for filename in [ADMINS_FILE, TEACHERS_FILE, ATTENDANCE_FILE, ASSIGNMENTS_FILE, SUBMISSIONS_FILE]:
        if not os.path.exists(filename):
            with open(filename, 'w') as f:
                json.dump([] if filename in [ADMINS_FILE, TEACHERS_FILE] else {}, f)
    
    bot = AssignmentBot()
    bot.run()
